<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="lib/WavAudioEncoder.js"></script>
    <script src="lib/Mp3LameEncoder.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>


</head>
<body>
    <h1>Audio</h1>

    <button id="startRecordingButton">Start recording</button>
    <button id="stopRecordingButton">Stop recording</button>
    <button id="keepButton">Keep Region</button>
    
    <button id="playButton">Play</button>

    <button id="uploadButton">Upload to S3</button>    
    <div id='waveform'></div>
    
    <script>

var bucketName = "personalpodcast";
var bucketRegion = "us-east-2";

  var IdentityPoolId = "us-east-2:dc78fe1b-579b-440e-9057-1899ee68c94e";
  
 AWS.config.update({
                region: bucketRegion,
                credentials: new AWS.CognitoIdentityCredentials({
                    IdentityPoolId: IdentityPoolId
                })
            });

            var s3 = new AWS.S3({
                apiVersion: '2006-03-01',
                params: {Bucket: bucketName}
        });
      
        var startRecordingButton = document.getElementById("startRecordingButton");
        var stopRecordingButton = document.getElementById("stopRecordingButton");
        var playButton = document.getElementById("playButton");
        var downloadButton = document.getElementById("downloadButton");
      var keepButton = document.getElementById("keepButton");
      var uploadButton = document.getElementById("uploadButton");
      
      keepButton.addEventListener("click", keepHighlightedRegions);
      uploadButton.addEventListener("click", uploadToS3);


        var leftchannel = [];
        var rightchannel = [];
        var recorder = null;
        var recordingLength = 0;
        var volume = null;
        var mediaStream = null;
        var context = null;
      var blob = null;
      var gumStream = null;
      var wavesurfer;

            	    wavesurfer = WaveSurfer.create({
		    container: '#waveform',
		    audioContext: context,
		    waveColor: 'violet',
		    progressColor: 'purple',
		    normalize: true,
		    barWidth: 5,
		    plugins: [
			WaveSurfer.regions.create({})
		    ]
		});

      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();

      
        startRecordingButton.addEventListener("click", function () {
            // Initialize recorder
	    leftchannel = [];
	    rightchannel = [];

            navigator.mediaDevices.getUserMedia( {
                audio: true
            }).then(
            function (e) {

                // creates the audio context

                // creates an audio node from the microphone incoming stream
                mediaStream = context.createMediaStreamSource(e);

		gumStream = e;
                // https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createScriptProcessor
                // bufferSize: the onaudioprocess event is called when the buffer is full
                var bufferSize = 2048;
                var numberOfInputChannels = 1;
                var numberOfOutputChannels = 1;
                if (context.createScriptProcessor) {
                    recorder = context.createScriptProcessor(bufferSize, numberOfInputChannels, numberOfOutputChannels);
                } else {
                    recorder = context.createJavaScriptNode(bufferSize, numberOfInputChannels, numberOfOutputChannels);
                }

                // we connect the recorder
		
		var gain = context.createGain();
		gain.gain.setValueAtTime(1.0, context.currentTime);
		mediaStream.connect(gain);
		gain.connect(recorder);

                recorder.connect(context.destination);
		
		
		recorder.onaudioprocess = function (e) {
                    leftchannel.push(e.inputBuffer.getChannelData(0));
                    //rightchannel.push(new Float32Array(e.inputBuffer.getChannelData(1)));
                    recordingLength += e.inputBuffer.getChannelData(0).length;
                }

            },
                        function (e) {
                            console.error(e);
                        });
        });


      function encode(left, recordingLength) {
            leftBuffer = flattenArray(left, recordingLength);
          //rightBuffer = flattenArray(right, recordingLength);

	    var encoder = new WavAudioEncoder(context.sampleRate, 1);
	    encoder.encode([leftBuffer]);
	    blob = encoder.finish();

	  wavesurfer.empty();
	  wavesurfer.clearRegions();
	    wavesurfer.loadBlob(blob);
	    wavesurfer.enableDragSelection({});
      }
      
        stopRecordingButton.addEventListener("click", function () {

            // stop recording
            recorder.disconnect();
            mediaStream.disconnect();
	    gumStream.getAudioTracks()[0].stop();	    

            // we flat the left and right channels down
            // Float32Array[] => Float32Array
	    encode(leftchannel, recordingLength);
        });

        playButton.addEventListener("click", function () {
            if (blob == null) {
                return;
            }

            //var url = window.URL.createObjectURL(blob);
            //var audio = new Audio(url);
            //audio.play();
	    wavesurfer.play();
        });

        /*downloadButton.addEventListener("click", function () {
            if (blob == null) {
                return;
            }

            var url = URL.createObjectURL(blob);

            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            a.href = url;
            a.download = "sample.wav";
            a.click();
            window.URL.revokeObjectURL(url);
        });*/

        function flattenArray(channelBuffer, recordingLength) {
            var result = new Float32Array(recordingLength);
            var offset = 0;
            for (var i = 0; i < channelBuffer.length; i++) {
                var buffer = channelBuffer[i];
                result.set(buffer, offset);
                offset += buffer.length;
            }
            return result;
        }

function keepHighlightedRegions() {
    // save initial region list
    var initialRegionList = Object.values(wavesurfer.regions.list);

    // sort the regions
    initialRegionList.sort((a, b) => (a.start > b.start ) ? 1 : -1 );

    var newLeft = [];
    var newRight = [];
    var recordingSize = 0;
    for (var region of initialRegionList) {
	var sampleStart = Math.floor(region.start*context.sampleRate);
	var sampleEnd = Math.floor(region.end*context.sampleRate);

	recordingSize += (sampleEnd - sampleStart + 1);
	newLeft.push(leftBuffer.subarray(sampleStart, sampleEnd));
	//newRight.push(rightBuffer.subarray(sampleStart, sampleEnd));
    }

    encode(newLeft, recordingSize);
    
}

      function uploadToS3()
      {
	  var key = new Date().toISOString() + '.mp3';
	  var encoder = new Mp3LameEncoder(context.sampleRate, 160);
	  encoder.encode([leftBuffer, leftBuffer]);
	    var mp3blob = encoder.finish();

	  s3.upload({
        Key: key,
        Body: mp3blob,
        ACL: 'private'
        }, function(err, data) {
        if(err) {
         
        }
	else{
	    //alert('Successfully Uploaded!');
	}
        }).on('httpUploadProgress', function (progress) {
      });
      }
      
    </script>
</body>
</html>

